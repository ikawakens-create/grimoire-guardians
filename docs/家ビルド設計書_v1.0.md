# 家ビルドシステム 設計書 v1.0

> Grimoire Guardians — Phase 1-D 実装仕様
> 作成日: 2026-02-26

---

## 1. コアコンセプト：「グリモアの異世界の家」

### 世界観設定

プレイヤーは「グリモア・ガーディアン（Grimoire Guardian）」として、算数の知識を使って様々な魔法の異世界を旅する。

- **学年 = 異世界**：1年生の問題が舞台の世界は「もりのせかい」、2年生は「うみのせかい」、3年生は「そらのせかい」...など、学年ごとに全く異なる魔法の異世界が存在する
- **家 = 異世界の拠点**：各世界に1つ、自分だけの家を建てる。ワールドを進めるごとに家が豪華になる
- **世界の移行**：1年生のすべてのワールドをクリアすると「グリモアの扉」が開き、次の異世界へワープ。旧世界の家は「記憶の本棚（きおくのほんだな）」からいつでも訪問できる

### 子供が熱中する仕掛け

| 仕掛け | 説明 |
|-------|------|
| **縦方向の成長** | 家が下から積み上がっていく（1階→庭→外観→2階→3階→塔）。進めるほど家が高くなる |
| **モンスター同居** | 図鑑で集めたモンスターが庭・室内に住める（生き生き動く）|
| **「あと◯個！」ヒント** | 次の家具・パーツまでの残り素材数を常に表示 |
| **クラフトアニメ** | 素材が家に飛んでいく演出→ドーン！と新パーツ登場 |
| **コレクション率** | 家具カタログの収集率 XX/100 を常に表示（完全コンプ不可能な量） |
| **季節イベント（Phase 2）** | 月ごとの限定デコで飽きさせない |
| **世界間ワープ演出** | 次の学年へ移行時に本が光る→ポータル演出→新世界に到着！ |

---

## 2. 家の構造：6セクション縦積みシステム

```
┌─────────────────────┐
│   ★ 屋上の塔         │ ← 全ワールドクリア後解放（レジェンドエリア）
├─────────────────────┤
│   ✦ 3階（まほうのま）  │ ← 世界16クリア後解放
├─────────────────────┤
│   ✦ 2階（べんきょうま） │ ← 世界12クリア後解放
├─────────────────────┤
│   ✦ 外観装飾          │ ← 世界8クリア後解放（バナー・表札・煙突）
├─────────────────────┤
│   ✦ 庭（にわ）        │ ← 世界4クリア後解放
├─────────────────────┤
│   🏠 1階（いま）       │ ← 最初から利用可能
└─────────────────────┘
```

### セクション詳細

#### 1階（いま） — 常時解放
- **家具スロット**: 4×2 = 8スロット（自由配置）
- **壁紙**: 6種（素材クラフトで解放）
- **床**: 4種（素材クラフトで解放）
- **デフォルト**: 何もない空の部屋（木の床、白壁）

#### 庭（にわ） — 世界4クリア後解放
- **外観スタイル**: 4バリエーション（テント/もくのいえ/れんがのいえ/宝石の家）
- **庭デコスロット**: 8スロット（木、花、噴水、石灯籠など）
- **モンスタースロット**: 3スロット（図鑑のモンスターを配置）
- **地面**: 4種（草地/石畳/花壇/水晶地面）

#### 外観装飾 — 世界8クリア後解放
- **バナー**: 4種（色・デザイン選択）
- **表札**: 3種（プレイヤー名が自動表示）
- **煙突**: 3種（煙が出るアニメ付き）
- **屋根飾り**: 3種（風見鶏/星/月）

#### 2階（べんきょうま） — 世界12クリア後解放
- **家具スロット**: 4×2 = 8スロット
- **壁紙**: 別途4種
- **床**: 別途3種
- **テーマ**: 勉強・知識・図書（本棚・望遠鏡など）

#### 3階（まほうのま） — 世界16クリア後解放
- **特殊スロット**: 6スロット（レア・超レアアイテムのみ配置可）
- **壁紙**: 魔法系2種
- **エフェクト**: 部屋全体に魔法陣のパーティクルが漂う（CSS animation）

#### 屋上の塔 — 全ワールドクリア後解放
- **特別デコ**: 星の間、銀河の窓
- **トロフィー**: ゲームクリアの証（永久飾り）
- **フォトモード**: 家のスクリーンショット撮影ボタン

---

## 3. 材料・クラフトシステム

### 素材とレアリティ

| 素材ID | 絵文字 | 名前 | レアリティ | 入手方法 |
|--------|--------|------|-----------|---------|
| wood | 🪵 | もくざい | common | 通常問題35%、普通パス70% |
| stone | 🪨 | いし | common | 通常問題35%、普通パス70% |
| brick | 🧱 | れんが | uncommon | モンスター撃破75%、三叉路レアパス |
| gem | 💎 | ほうせき | rare | モンスター100%（レア）、宝箱 |
| star_fragment | ✨ | ほしのかけら | super_rare | 三叉路レアパス100%、宝箱 |

### 外観スタイルレシピ（庭解放後）

| スタイル名 | レシピ | ロック条件 |
|-----------|--------|----------|
| もくのいえ（自然） | wood×5 | 庭解放後 |
| もくのいえ（いろえ） | wood×5 + paint×2 | 庭解放後 |
| いしのいえ | stone×8 + wood×3 | 庭解放後 |
| れんがのいえ | brick×8 + stone×5 | 外観装飾解放後 |
| ほうせきのいえ | gem×5 + brick×5 | 外観装飾解放後 |
| ほしのいえ | star_fragment×3 + gem×3 | 3階解放後 |

### 1階家具レシピ

| アイテムID | 名前 | レシピ | レアリティ |
|-----------|------|--------|----------|
| bed_wood | きのベッド | wood×5 + cloth×3 | common |
| desk_study | べんきょうつくえ | wood×5 | common |
| bookshelf_small | ちいさいほんだな | wood×5 + brick×2 | common |
| chair_wood | きのいす | wood×3 | common |
| table_wood | きのテーブル | wood×4 | common |
| lamp_floor | たちランプ | wood×2 + stone×1 | common |
| rug_simple | じゅうたん | cloth×5 | common |
| sofa_wood | ソファ | wood×4 + cloth×4 | uncommon |
| bookshelf_large | おおきいほんだな | wood×8 + brick×3 | uncommon |
| fireplace | だんろ | stone×6 + brick×4 | uncommon |
| rug_star | ほしのじゅうたん | cloth×5 + paint×2 | uncommon |
| chair_throne | おうさまのいす | wood×3 + crown×1 | rare |
| lamp_magic | まほうのランプ | gem×2 + magic_orb×1 | rare |
| crystal_ball | すいしょうだま | gem×5 + star_fragment×1 | super_rare |
| cauldron | まほうのなべ | stone×5 + magic_orb×2 | super_rare |
| picture_frame | かべかざり | wood×2 | common（モンスター額縁） |

### 庭デコレシピ

| アイテムID | 名前 | レシピ | レアリティ |
|-----------|------|--------|----------|
| tree_apple | りんごのき | wood×3 | common |
| tree_cherry | さくらのき | wood×4 + paint×1 | common |
| flower_tulip | チューリップ | wood×1 + paint×1 | common |
| flower_sunflower | ひまわり | wood×1 + paint×2 | common |
| fence_wood | きのフェンス | wood×4 | common |
| fence_stone | いしのフェンス | stone×4 | common |
| lamp_post | がいとう | stone×2 + gem×1 | uncommon |
| bench_wood | きのベンチ | wood×3 | common |
| well | いど | stone×5 | uncommon |
| mailbox | ポスト | wood×2 + paint×1 | common |
| fountain | ふんすい | stone×6 + gem×1 | uncommon |
| pond | いけ | stone×4 + gem×2 | uncommon |
| fence_flower | はなのフェンス | wood×2 + paint×3 | uncommon |
| tree_magic | まほうのき | wood×5 + gem×2 | rare |
| statue_star | ほしのぞう | stone×5 + star_fragment×1 | rare |
| mushroom_giant | おおきなきのこ | wood×2 + gem×1 | rare |
| magic_circle | まほうのじん | gem×3 + star_fragment×1 | super_rare |

### 壁紙・床レシピ

| アイテムID | 種別 | 名前 | レシピ |
|-----------|------|------|--------|
| wallpaper_floral | 壁紙 | はなもよう | cloth×3 + paint×2 |
| wallpaper_stars | 壁紙 | ほしもよう | cloth×3 + gem×1 |
| wallpaper_stripes | 壁紙 | しましま | cloth×4 |
| wallpaper_plaid | 壁紙 | チェック | cloth×4 + paint×1 |
| wallpaper_magic | 壁紙 | まほうもよう | cloth×3 + magic_orb×1 |
| wallpaper_clouds | 壁紙 | くもとそら | cloth×3 + star_fragment×1 |
| floor_wood_light | 床 | うすいきのゆか | wood×4 |
| floor_wood_dark | 床 | こいきのゆか | wood×5 |
| floor_stone | 床 | いしのゆか | stone×5 |
| floor_carpet_red | 床 | あかじゅうたん | cloth×6 + paint×2 |

### 2階家具（世界12解放後）

| アイテムID | 名前 | レシピ | テーマ |
|-----------|------|--------|-------|
| telescope | ぼうえんきょう | stone×3 + gem×2 | 天体 |
| globe | ちきゅうぎ | wood×3 + paint×2 | 地理 |
| map_poster | ちずかざり | cloth×2 + paint×2 | 地理 |
| bookshelf_magic | まほうのほんだな | wood×8 + magic_orb×1 | 魔法 |
| abacus | そろばん | wood×3 | 算数 |
| clock_wall | かべどけい | wood×2 + stone×1 | 時計 |
| lamp_study | べんきょうランプ | wood×1 + gem×1 | 勉強 |
| bed_cloud | くものベッド | cloth×8 + star_fragment×1 | レア |

### 3階アイテム（世界16解放後）

| アイテムID | 名前 | レシピ | 備考 |
|-----------|------|--------|------|
| magic_mirror | まほうのかがみ | gem×5 + magic_orb×2 | 超レア |
| star_throne | ほしのざ | star_fragment×3 + crown×1 | 超レア |
| orb_stand | たまのだい | gem×3 + magic_orb×3 | 超レア |
| astral_rug | ほしぞらじゅうたん | cloth×8 + star_fragment×2 | 超レア |
| grimoire_stand | グリモアだい | wood×5 + magic_orb×3 | 超レア |
| crystal_window | すいしょうのまど | gem×8 + star_fragment×2 | 超レア |

---

## 4. 状態設計（GameStore拡張）

```javascript
// GameStore._getInitialState() に追加
house: {
  // セクション解放状態
  sections: {
    floor1: true,          // 常時解放
    garden: false,         // 世界4クリア後
    exterior: false,       // 世界8クリア後
    floor2: false,         // 世界12クリア後
    floor3: false,         // 世界16クリア後
    tower: false,          // 全ワールドクリア後
  },

  // 外観スタイル（庭解放後選択可）
  exteriorStyle: 'default',  // 'default' | アイテムID

  // 外観装飾（exterior解放後）
  exteriorDeco: {
    banner: null,
    signboard: null,
    chimney: null,
    roofDeco: null,
  },

  // 庭
  garden: {
    path: 'path_grass',          // デフォルト草地
    decorations: Array(8).fill(null),   // 8スロット（アイテムID or null）
    monsters: Array(3).fill(null),      // モンスタースロット（モンスターID or null）
  },

  // 1階
  floor1: {
    wallpaper: null,             // アイテムID or null（nullはデフォルト白）
    floor: null,                 // アイテムID or null（nullはデフォルト木）
    furniture: Array(8).fill(null),   // 8スロット
  },

  // 2階（解放後のみ使用）
  floor2: {
    wallpaper: null,
    floor: null,
    furniture: Array(8).fill(null),
  },

  // 3階（解放後のみ使用）
  floor3: {
    wallpaper: null,
    floor: null,
    furniture: Array(6).fill(null),   // 特殊スロット6
  },

  // 屋上の塔（解放後のみ使用）
  tower: {
    decorations: Array(4).fill(null),
  },

  // 収集記録（実績・コレクション率計算用）
  crafted: [],                   // クラフト済みアイテムIDの配列

  // メタ情報
  lastUpdated: null,             // ISO日時文字列
},
```

---

## 5. ファイル構成

### 新規作成ファイル

```
src/data/houseItems.js          ← アイテムカタログ（全レシピ・画像パス・レアリティ）
src/screens/HouseScreen.js      ← メイン家画面（モード切替・表示）
src/screens/HouseBuildScreen.js ← クラフト・配置UI
src/core/HouseManager.js        ← クラフトロジック・セクション解放判定
```

### 修正ファイル

```
src/core/Config.js              ← ENABLE_HOUSE_BUILD: true、SECTION_UNLOCK_WORLDS定数
src/core/GameStore.js           ← house ステート追加・初期化
src/screens/MemoryIsleScreen.js ← 「いえへ」ボタン接続
src/core/SaveManager.js         ← house ステート保存・復元対応
sw.js                           ← 新アセットキャッシュ追加
```

### アセットディレクトリ構造

```
assets/house/
├── stages/               ← 外観プリセット画像（完成品イラスト）
│   ├── house_default.png
│   ├── house_wood_natural.png
│   ├── house_wood_painted.png
│   ├── house_stone.png
│   ├── house_brick.png
│   ├── house_gem.png
│   └── house_star.png
├── garden/               ← 庭デコアイテム（128×128px 透明PNG）
│   └── *.png
├── interior/             ← 室内アイテム（128×128px 透明PNG）
│   ├── furniture/
│   ├── wallpapers/
│   └── floors/
├── exterior/             ← 外観装飾アイテム（128×128px 透明PNG）
│   └── *.png
└── ui/                   ← UIパーツ
    ├── slot_empty.png
    ├── slot_locked.png
    └── section_locked_banner.png
```

---

## 6. Gemini画像依頼リスト（第1弾）

### スタイルガイド（全画像共通）
- タッチ操作の子供向けゲーム用イラスト
- 可愛いファンタジー系（ジブリ・どうぶつの森の中間）
- 柔らかいパステル調、輪郭線あり、影あり立体感
- 透明PNG（背景なし）
- 家の全景: 横640×480px
- アイテム単品: 128×128px

### 家の全景（外観プリセット）7枚 — 横640×480px

| ファイル名 | 内容 |
|-----------|------|
| house_default.png | 木のテント小屋。三角形の布テント、入口に小さなドア |
| house_wood_natural.png | 自然な木の家。丸太造り、わら屋根、石の煙突 |
| house_wood_painted.png | カラフルに塗られた木の家。ピンク・黄色・水色のペンキ |
| house_stone.png | 石造りの家。灰色の石壁、赤い三角屋根 |
| house_brick.png | れんが造りの家。赤レンガ、緑の窓枠、白いドア |
| house_gem.png | 宝石が光る豪邸。クリスタルの壁、輝く青い屋根 |
| house_star.png | 星と月の城。白と金の塔、星がちりばめられた青い屋根 |

### 庭デコ 17枚 — 128×128px 透明PNG

tree_apple, tree_cherry, tree_magic（金色に光る木）, flower_tulip, flower_sunflower, flower_magic（虹色の花）, fence_wood, fence_stone, fence_flower, lamp_post, bench_wood, well, mailbox, fountain, pond, mushroom_giant, magic_circle（地面に光る六芒星）

### 1階家具 16枚 — 128×128px 透明PNG

bed_wood, desk_study, bookshelf_small, bookshelf_large, chair_wood, chair_throne, table_wood, lamp_floor, lamp_magic, rug_simple, rug_star, sofa_wood, fireplace, crystal_ball, cauldron, picture_frame

### 壁紙 6枚 — 256×256px タイルパターン PNG（背景あり）

wallpaper_floral（花柄）, wallpaper_stars（星柄）, wallpaper_stripes（縦縞）, wallpaper_plaid（チェック）, wallpaper_magic（魔法陣）, wallpaper_clouds（雲と空）

### 床 4枚 — 256×256px タイルパターン PNG（背景あり）

floor_wood_light（薄い木目）, floor_wood_dark（濃い木目）, floor_stone（石畳）, floor_carpet_red（赤絨毯）

**第1弾合計: 50枚**

---

## 7. UI設計：HouseScreen

### 画面レイアウト

```
┌────────────────────────────────────────────────────┐
│  ← もどる          🏠 グリモアのいえ        🔨 へんしゅう  │
├────────────────────────────────────────────────────┤
│                                                    │
│  [セクションタブ: 1かい | にわ | そとかざり | 2かい ... ] │
│                                                    │
│  ┌──────────────────────────────────────────────┐  │
│  │                                              │  │
│  │       家の表示エリア（スクロール可）             │  │
│  │       外観: <img> プリセット画像               │  │
│  │       室内: 背景 + CSS gridスロット            │  │
│  │       庭: 背景 + 絶対配置スロット              │  │
│  │                                              │  │
│  └──────────────────────────────────────────────┘  │
│                                                    │
│  コレクション率: ████░░░░ 12/50                      │
└────────────────────────────────────────────────────┘
```

### 編集モード（へんしゅうボタン押下後）

```
┌────────────────────────────────────────────────────┐
│  ✕ とじる          🔨 へんしゅうちゅう      💾 ほぞん   │
├──────────────────┬─────────────────────────────────┤
│                  │  カテゴリ選択                     │
│                  │  [壁紙][床][家具][モンスター]      │
│   家の表示エリア  │─────────────────────────────────┤
│   （スロットが    │  アイテム一覧                    │
│   　タップ可に）  │  ┌──┐┌──┐┌──┐┌──┐             │
│                  │  │🛏│  │🪑│  │🪴│  │🔮│            │
│                  │  └──┘└──┘└──┘└──┘             │
│                  │  ┌──┐┌──┐                        │
│                  │  │🔒│  │🔒│  ← 素材不足でロック   │
│                  │  └──┘└──┘                        │
│                  │  あと wood×3でクラフトできる！     │
└──────────────────┴─────────────────────────────────┘
```

### クラフト画面

- アイテムタップ → 必要素材 + 「つくる！」ボタン表示
- 素材が足りる場合: 「つくる！」ボタンが光る
- 素材が足りない場合: 不足分を赤表示 + 「あと◯こ必要」
- クラフト成功アニメ: 素材が飛んでいく → キラキラ → アイテム出現

---

## 8. セクション解放システム

### 解放判定ロジック

```javascript
// HouseManager.checkSectionUnlocks()
// ワールドクリア後に毎回チェックする

const SECTION_UNLOCK = {
  garden:   { clearedWorlds: 4  },  // 世界4クリア後
  exterior: { clearedWorlds: 8  },  // 世界8クリア後
  floor2:   { clearedWorlds: 12 },  // 世界12クリア後
  floor3:   { clearedWorlds: 16 },  // 世界16クリア後
  tower:    { clearedWorlds: 33 },  // 全ワールドクリア（1年生33ワールド）
};
```

### 解放演出

- セクション解放時: モーダル表示「🎉 にわが解放されました！」
- 家に新しいフロアが積み上がるアニメ
- SoundManager.play(SoundType.SYSTEM.LEVEL_UP)

---

## 9. 学年間移行（ワープ）システム

### 移行フロー

1. 1年生全ワールドクリア
2. エンディング画面: 「1ねんせいのまほうをすべてマスターした！」
3. 「つぎのせかいへ」ボタン
4. ワープアニメ（3〜4秒）: グリモアが光る → 渦巻き → 新世界到着
5. 2年生の新しい家（テント状態）でスタート

### データ管理

```javascript
// 各学年の家データを独立して保持
houses: {
  grade1: { /* 1年生の家データ */ },
  grade2: { /* 2年生の家データ */ },
  // ...
},
currentGrade: 1,  // 現在プレイ中の学年
```

### 「きおくのほんだな」（過去の家訪問）

- タイトル画面またはメニューから「きおくのほんだな」を選択
- 旧学年の家を閲覧専用で表示（編集不可）
- 「なつかしいな〜」という感情を演出（子供の達成感）

---

## 10. 実装フェーズ

| Step | 内容 | 推定難易度 |
|------|------|-----------|
| 1 | `src/data/houseItems.js` 作成（全アイテムカタログ） | ★★☆ |
| 2 | `Config.js` 拡張（HOUSE_CONFIG、SECTION_UNLOCK定数） | ★☆☆ |
| 3 | `GameStore.js` 拡張（house ステート追加） | ★☆☆ |
| 4 | `HouseManager.js` 作成（クラフト・解放ロジック） | ★★★ |
| 5 | `HouseScreen.js` 作成（表示メイン画面） | ★★★ |
| 6 | `HouseBuildScreen.js` 作成（クラフト・配置UI） | ★★★ |
| 7 | MemoryIsle接続 + `sw.js` 更新 + `SaveManager` 対応 | ★★☆ |
| 8 | Gemini画像差し替え（画像届き次第） | ★☆☆ |

---

*設計書 v1.0 — 2026-02-26 作成*
